name: Notify Discord when PR enters code review
on:
  pull_request:
    types: [review_requested]
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL_PR }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
          REVIEWER_LOGIN: ${{ github.event.requested_reviewer.login }}
          TEAM_NAME: ${{ github.event.requested_team.name }}
        run: |
          reviewer="${REVIEWER_LOGIN:-}"
          team="${TEAM_NAME:-}"

          if [ -n "$reviewer" ]; then
            mention="@$reviewer"
            label="Revisor"
            value="$reviewer"
          elif [ -n "$team" ]; then
            mention="@$team"
            label="Equipe"
            value="$team"
          else
            mention="@reviewers"
            label="Revisor"
            value="Não informado"
          fi

          payload=$(jq -n \
            --arg repo "$REPO" \
            --arg title "$PR_TITLE" \
            --arg url "$PR_URL" \
            --arg author "$PR_AUTHOR" \
            --arg mention "$mention" \
            --arg label "$label" \
            --arg value "$value" \
            '{
              content: "\($mention) PR pronto para revisão em **\($repo)**",
              embeds: [
                {
                  title: $title,
                  url: $url,
                  description: "Autor: \($author)",
                  fields: [
                    {
                      name: $label,
                      value: $value,
                      inline: true
                    }
                  ]
                }
              ]
            }')
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$WEBHOOK"
