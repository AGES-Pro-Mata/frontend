name: ğŸ”„ SincronizaÃ§Ã£o GitHub â†’ GitLab AGES

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, closed, merged, synchronize, reopened]
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  create:
  delete:
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'ForÃ§ar sincronizaÃ§Ã£o completa'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '*/30 * * * *'

env:
  GITLAB_URL: ${{ vars.GITLAB_URL || 'https://tools.ages.pucrs.br' }}
  GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
  GITLAB_PROJECT_ID: ${{ vars.GITLAB_PROJECT_ID }}
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

jobs:
  sync-to-gitlab:
    name: ğŸ¦Š Sincronizar com GitLab AGES
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout do RepositÃ³rio
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GIT_TOKEN }}

    - name: âš™ï¸ Configurar Git
      run: |
        git config --global user.name "GitHub Actions Sync"
        git config --global user.email "sync@promata.ages.pucrs.br"
        git config --global init.defaultBranch main

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Instalar DependÃªncias
      run: |
        pip install --upgrade pip
        pip install requests python-gitlab python-dateutil pytz

    - name: ğŸ“‹ Verificar ConfiguraÃ§Ã£o
      run: |
        echo "ğŸ” Verificando configuraÃ§Ã£o..."
        echo "RepositÃ³rio: ${{ github.repository }}"
        echo "GitLab URL: $GITLAB_URL"
        echo "Project ID: $GITLAB_PROJECT_ID"
        echo "Trigger: ${{ github.event_name }}"

    - name: ğŸ”„ Executar SincronizaÃ§Ã£o Completa
      run: python3 .github/scripts/sync-complete.py

    - name: ğŸ“¤ Upload do RelatÃ³rio de SincronizaÃ§Ã£o
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: sync-report-${{ github.run_number }}
        path: sync-report.md
        retention-days: 30