name: üîÑ Sincroniza√ß√£o GitHub ‚Üí GitLab AGES

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, closed, merged, synchronize, reopened]
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  create:
  delete:
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'For√ßar sincroniza√ß√£o completa'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '*/30 * * * *'

env:
  GITLAB_URL: ${{ vars.GITLAB_URL || 'https://tools.ages.pucrs.br' }}
  GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
  GITLAB_PROJECT_ID: ${{ vars.GITLAB_PROJECT_ID }}
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

jobs:
  sync-to-gitlab:
    name: ü¶ä Sincronizar com GitLab AGES
    runs-on: ubuntu-latest
    if: ${{ env.GITLAB_TOKEN != '' && env.GITLAB_PROJECT_ID != '' }}
    steps:
    - name: üì• Checkout do Reposit√≥rio
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GIT_TOKEN }}

    - name: ‚öôÔ∏è Configurar Git
      run: |
        git config --global user.name "GitHub Actions Sync"
        git config --global user.email "sync@promata.ages.pucrs.br"
        git config --global init.defaultBranch main

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: üì¶ Instalar Depend√™ncias
      run: |
        pip install --upgrade pip
        pip install requests python-gitlab python-dateutil pytz

    - name: üìã Verificar Configura√ß√£o
      run: |
        echo "üîç Verificando configura√ß√£o..."
        echo "Reposit√≥rio: ${{ github.repository }}"
        echo "GitLab URL: $GITLAB_URL"
        echo "Project ID: $GITLAB_PROJECT_ID"
        echo "Trigger: ${{ github.event_name }}"

    - name: üîÑ Executar Sincroniza√ß√£o Completa
      run: python3 .github/scripts/sync-complete.py

    - name: üì§ Upload do Relat√≥rio de Sincroniza√ß√£o
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: sync-report-${{ github.run_number }}
        path: sync-report.md
        retention-days: 30