name: üîÑ Sincroniza√ß√£o GitHub ‚Üí GitLab AGES

on:
  # Triggers autom√°ticos
  push:
    branches: ['**']
  pull_request:
    types: [opened, closed, merged, synchronize, reopened]
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  create:
  delete:

  # Trigger manual
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'For√ßar sincroniza√ß√£o completa'
        required: false
        default: 'false'
        type: boolean
        
  # Sincroniza√ß√£o peri√≥dica (a cada 30 minutos)
  schedule:
    - cron: '*/30 * * * *'

env:
  GITLAB_URL: ${{ vars.GITLAB_URL || 'https://tools.ages.pucrs.br' }}
  GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
  GITLAB_PROJECT_ID: ${{ vars.GITLAB_PROJECT_ID }}
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

jobs:
  sync-to-gitlab:
    name: ü¶ä Sincronizar com GitLab AGES
    runs-on: ubuntu-latest
    
    # S√≥ executa se a sincroniza√ß√£o estiver habilitada
    if: ${{ secrets.GITLAB_TOKEN != '' && vars.GITLAB_PROJECT_ID != '' }}
    
    steps:
    - name: üì• Checkout do Reposit√≥rio
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Hist√≥rico completo para mirror
        token: ${{ secrets.GIT_TOKEN }}

    - name: ‚öôÔ∏è Configurar Git
      run: |
        git config --global user.name "GitHub Actions Sync"
        git config --global user.email "sync@promata.ages.pucrs.br"
        git config --global init.defaultBranch main

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: üì¶ Instalar Depend√™ncias
      run: |
        pip install --upgrade pip
        pip install requests python-gitlab python-dateutil pytz

    - name: üìã Verificar Configura√ß√£o
      run: |
        echo "üîç Verificando configura√ß√£o..."
        echo "Reposit√≥rio: ${{ github.repository }}"
        echo "GitLab URL: $GITLAB_URL"
        echo "Project ID: $GITLAB_PROJECT_ID"
        echo "Trigger: ${{ github.event_name }}"

    - name: üîÑ Executar Sincroniza√ß√£o Completa
      run: python3 .github/scripts/sync-complete.py
